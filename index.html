<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Cloud & Text Analyzer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <!-- PDF.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Mammoth.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Word (.docx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- WordCloud2.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Word Cloud -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Canvas */
        #word-cloud-canvas {
            width: 100%;
            height: 500px;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: white; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô CSS */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- Header -->
    <header class="bg-indigo-600 text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">üìÑ Word Cloud Analyzer</h1>
            <p class="mt-2 text-indigo-100">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF, Word ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏•‡∏á‡πÑ‡∏õ</p>
        </div>
    </header>

    <main class="container mx-auto p-6">
        
        <!-- Control Panel -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Input Section (File or Text) -->
                <div class="flex flex-col space-y-4">
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    
                    <!-- File Upload -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition relative group">
                        <input type="file" id="fileInput" accept=".pdf,.docx" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="flex flex-col items-center justify-center h-full">
                            <svg class="w-10 h-10 text-gray-400 mb-2 group-hover:text-indigo-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-sm text-gray-600 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF / Word</p>
                            <p id="fileNameDisplay" class="text-indigo-600 font-bold mt-2 text-sm hidden"></p>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="relative flex items-center justify-center my-2">
                        <hr class="w-full border-gray-200">
                        <span class="absolute bg-white px-2 text-xs text-gray-400 uppercase tracking-widest">‡∏´‡∏£‡∏∑‡∏≠ (OR)</span>
                    </div>

                    <!-- Text Area Input -->
                    <div class="relative">
                         <label for="textInput" class="block text-sm font-medium text-gray-600 mb-1">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</label>
                        <textarea id="textInput" rows="4" 
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                            placeholder="Paste your text here..."></textarea>
                    </div>
                </div>

                <!-- Settings & Actions -->
                <div class="flex flex-col space-y-4">
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h2>
                    
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-4">
                        
                        <!-- Shape Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á Word Cloud</label>
                            <select id="shapeSelect" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="circle">‡∏ß‡∏á‡∏Å‡∏•‡∏° (Circle)</option>
                                <option value="square">‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° (Square)</option>
                                <option value="star">‡∏î‡∏≤‡∏ß (Star)</option>
                                <option value="diamond">‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏•‡∏≤‡∏°‡∏ï‡∏±‡∏î (Diamond)</option>
                                <option value="triangle-forward">‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° (Triangle)</option>
                                <option value="pentagon">‡∏´‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° (Pentagon)</option>
                            </select>
                        </div>

                        <!-- Word Length Filter -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≥‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</label>
                                <input type="number" id="minWordLength" value="2" min="1" class="w-full border-gray-300 rounded-md shadow-sm border p-2 text-center" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</label>
                                <input type="number" id="maxWordLength" value="10" min="1" class="w-full border-gray-300 rounded-md shadow-sm border p-2 text-center" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡πÉ‡∏™‡πà 0 ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î)">
                            </div>
                        </div>

                        <!-- Max Words Limit -->
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (Top Words)</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="maxWordsRange" min="5" max="300" step="5" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <span id="maxWordsValue" class="text-sm font-bold text-indigo-600 w-12 text-center">100</span>
                            </div>
                        </div>

                        <!-- Checkboxes -->
                        <div class="flex flex-col space-y-2 pt-2">
                            <div class="flex space-x-2 items-start">
                                <input type="checkbox" id="removeStopWords" checked class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="removeStopWords" class="text-sm text-gray-700 leading-snug">
                                    ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°/‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏≤‡∏° (Stopwords)
                                </label>
                            </div>
                            
                            <div class="flex space-x-2 items-center">
                                <input type="checkbox" id="removeSymbols" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="removeSymbols" class="text-sm text-gray-700">
                                    ‡∏ï‡∏±‡∏î‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© (!@#$%) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow"></div> 

                    <div class="flex space-x-3 pt-2">
                        <button id="analyzeBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition flex justify-center items-center transform hover:-translate-y-0.5">
                            <span id="btnText">üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Word Cloud</span>
                            <div id="loader" class="loader ml-2 hidden" style="width: 20px; height: 20px; border-width: 3px;"></div>
                        </button>
                        <button id="resetBtn" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 font-bold py-3 px-4 rounded-lg shadow-sm transition">
                            ‚ùå Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section (Hidden initially) -->
        <div id="resultsSection" class="hidden space-y-8 animate-fade-in-up">
            
            <!-- Word Cloud Display -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        üå•Ô∏è Word Cloud 
                        <span id="wordCountBadge" class="ml-3 text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full"></span>
                    </h2>
                    <button id="saveBtn" class="text-sm bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded shadow transition font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (PNG)
                    </button>
                </div>
                <!-- Canvas Container -->
                <div class="relative w-full border border-gray-200 rounded-lg overflow-hidden bg-white" style="height: 500px;">
                    <canvas id="word-cloud-canvas" width="1000" height="500"></canvas>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-right">*‡∏´‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
            </div>

            <!-- Frequency Table -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Ñ‡∏≥</h2>
                <div class="overflow-x-auto max-h-96 border border-gray-100 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (Word)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (Frequency)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß</th>
                            </tr>
                        </thead>
                        <tbody id="freqTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center text-gray-400 py-6 text-sm">
        <p>Word Cloud Analyzer - Client-Side Processing</p>
    </footer>

    <script>
        // --- Configuration & Setup ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Stopwords
        const defaultStopWords = new Set([
            // English Common Stopwords
            'a', 'about', 'above', 'after', 'again', 'against', 'all', 'am', 'an', 'and', 'any', 'are', 'aren\'t', 'as', 'at',
            'be', 'because', 'been', 'before', 'being', 'below', 'between', 'both', 'but', 'by', 
            'can', 'cannot', 'could', 'couldn\'t', 'did', 'didn\'t', 'do', 'does', 'doesn\'t', 'doing', 'don\'t', 'down', 'during',
            'each', 'few', 'for', 'from', 'further', 'had', 'hadn\'t', 'has', 'hasn\'t', 'have', 'haven\'t', 'having', 'he', 'he\'d', 'he\'ll', 'he\'s', 'her', 'here', 'here\'s', 'hers', 'herself', 'him', 'himself', 'his', 'how', 'how\'s',
            'i', 'i\'d', 'i\'ll', 'i\'m', 'i\'ve', 'if', 'in', 'into', 'is', 'isn\'t', 'it', 'it\'s', 'its', 'itself',
            'let\'s', 'me', 'more', 'most', 'mustn\'t', 'my', 'myself',
            'no', 'nor', 'not', 'of', 'off', 'on', 'once', 'only', 'or', 'other', 'ought', 'our', 'ours', 'ourselves', 'out', 'over', 'own',
            'same', 'shan\'t', 'she', 'she\'d', 'she\'ll', 'she\'s', 'should', 'shouldn\'t', 'so', 'some', 'such',
            'than', 'that', 'that\'s', 'the', 'their', 'theirs', 'them', 'themselves', 'then', 'there', 'there\'s', 'these', 'they', 'they\'d', 'they\'ll', 'they\'re', 'they\'ve', 'this', 'those', 'through', 'to', 'too', 'under', 'until', 'up',
            'very', 'was', 'wasn\'t', 'we', 'we\'d', 'we\'ll', 'we\'re', 'we\'ve', 'were', 'weren\'t', 'what', 'what\'s', 'when', 'when\'s', 'where', 'where\'s', 'which', 'while', 'who', 'who\'s', 'whom', 'why', 'why\'s', 'with', 'won\'t', 'would', 'wouldn\'t',
            'you', 'you\'d', 'you\'ll', 'you\'re', 'you\'ve', 'your', 'yours', 'yourself', 'yourselves',
            
            // Thai Stopwords (Updated)
            '‡∏ó‡∏µ‡πà', '‡∏ã‡∏∂‡πà‡∏á', '‡∏≠‡∏±‡∏ô', '‡πÅ‡∏ï‡πà', '‡∏´‡∏£‡∏∑‡∏≠', '‡πÅ‡∏•‡∏∞', '‡∏Å‡πá', '‡∏Ç‡∏≠‡∏á', '‡πÉ‡∏ô', '‡∏ö‡∏ô', '‡∏•‡πà‡∏≤‡∏á', '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠', '‡πÉ‡∏ï‡πâ', '‡∏à‡∏≤‡∏Å', '‡πÇ‡∏î‡∏¢', '‡πÄ‡∏°‡∏∑‡πà‡∏≠', '‡πÄ‡∏û‡∏∑‡πà‡∏≠', '‡∏ß‡πà‡∏≤', '‡πÄ‡∏õ‡πá‡∏ô', '‡∏≠‡∏¢‡∏π‡πà', '‡∏Ñ‡∏∑‡∏≠', '‡∏à‡∏∞', '‡πÑ‡∏î‡πâ', '‡πÉ‡∏´‡πâ', '‡πÑ‡∏õ', '‡∏°‡∏≤', '‡∏ô‡∏µ‡πâ', '‡∏ô‡∏±‡πâ‡∏ô', '‡πÇ‡∏ô‡πâ‡∏ô',
            // ‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡∏ô‡∏ò‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
            '‡πÄ‡∏ä‡πà‡∏ô', '‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', '‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô', '‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô', '‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô', '‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡∏ß‡πà‡∏≤', 
            '‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ', '‡∏Ø‡∏•‡∏Ø', '‡∏Å‡πá‡∏ï‡∏≤‡∏°', '‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡πâ', '‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤', '‡πÅ‡∏ï‡πà‡∏ß‡πà‡∏≤', '‡∏™‡πà‡∏ß‡∏ô', '‡∏à‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏±‡πà‡∏á', '‡∏ï‡∏•‡∏≠‡∏î‡∏à‡∏ô', '‡∏≠‡∏ô‡∏∂‡πà‡∏á', '‡∏î‡∏±‡∏á‡∏ó‡∏µ‡πà', '‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß', 
            '‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ', '‡∏≠‡∏µ‡∏Å‡∏ó‡∏±‡πâ‡∏á', '‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á', '‡∏≠‡∏≤‡∏ó‡∏¥', '‡πÄ‡∏û‡∏£‡∏≤‡∏∞', '‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏£‡∏≤‡∏∞', '‡∏î‡πâ‡∏ß‡∏¢', '‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ', '‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏Å‡πá‡∏ï‡∏≤‡∏°', '‡∏ó‡∏ß‡πà‡∏≤', '‡∏Ñ‡∏£‡∏±‡πâ‡∏ô',
            '‡∏´‡∏≤‡∏Å', '‡∏ñ‡πâ‡∏≤', '‡πÅ‡∏°‡πâ‡∏ô', '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£', '‡∏ï‡∏£‡∏≤‡∏ö‡πÉ‡∏î', '‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤', '‡∏î‡∏±‡πà‡∏á', '‡∏£‡∏≤‡∏ß‡∏Å‡∏±‡∏ö', '‡∏î‡∏∏‡∏à', '‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô', '‡∏õ‡∏£‡∏∞‡∏´‡∏ô‡∏∂‡πà‡∏á'
        ]);

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const textInput = document.getElementById('textInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loader = document.getElementById('loader');
        const btnText = document.getElementById('btnText');
        const resultsSection = document.getElementById('resultsSection');
        const freqTableBody = document.getElementById('freqTableBody');
        const canvas = document.getElementById('word-cloud-canvas');
        const shapeSelect = document.getElementById('shapeSelect');
        const maxWordsRange = document.getElementById('maxWordsRange');
        const maxWordsValue = document.getElementById('maxWordsValue');
        const minWordLengthInput = document.getElementById('minWordLength');
        const maxWordLengthInput = document.getElementById('maxWordLength');
        const wordCountBadge = document.getElementById('wordCountBadge');

        // State
        let selectedFile = null;

        // --- Event Listeners ---

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                fileNameDisplay.textContent = `üìÇ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${selectedFile.name}`;
                fileNameDisplay.classList.remove('hidden');
                textInput.value = '';
                textInput.setAttribute('disabled', 'true');
                textInput.classList.add('bg-gray-100');
            }
        });

        textInput.addEventListener('input', () => {
            if (textInput.value.length > 0) {
                selectedFile = null;
                fileInput.value = '';
                fileNameDisplay.classList.add('hidden');
            }
        });

        maxWordsRange.addEventListener('input', (e) => {
            maxWordsValue.textContent = e.target.value;
        });

        resetBtn.addEventListener('click', () => {
            location.reload();
        });

        saveBtn.addEventListener('click', () => {
            try {
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ã‡∏ü
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tCtx = tempCanvas.getContext('2d');
                
                // Fill White Background
                tCtx.fillStyle = '#FFFFFF';
                tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Draw original canvas over
                tCtx.drawImage(canvas, 0, 0);

                const dataUrl = tempCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `wordcloud_${new Date().getTime()}.png`;
                link.href = dataUrl;
                document.body.appendChild(link); // ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á Browser
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ' + err.message);
            }
        });

        analyzeBtn.addEventListener('click', async () => {
            const rawText = textInput.value;

            if (!selectedFile && !rawText.trim()) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏±‡∏ö');
                return;
            }

            setLoading(true);

            // ‡∏£‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å
            setTimeout(async () => {
                try {
                    let textContent = '';
                    
                    if (selectedFile) {
                        if (selectedFile.name.toLowerCase().endsWith('.pdf')) {
                            textContent = await parsePDF(selectedFile);
                        } else if (selectedFile.name.toLowerCase().endsWith('.docx')) {
                            textContent = await parseDocx(selectedFile);
                        } else {
                            throw new Error('‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .pdf ‡πÅ‡∏•‡∏∞ .docx ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                        }
                    } else {
                        textContent = rawText;
                    }

                    if (!textContent.trim()) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ');
                    }

                    const wordCounts = processText(textContent);
                    displayResults(wordCounts);
                    
                } catch (error) {
                    console.error(error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                } finally {
                    setLoading(false);
                }
            }, 100);
        });

        // --- Core Functions ---

        function setLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
                analyzeBtn.disabled = true;
                resultsSection.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                btnText.textContent = 'üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Word Cloud';
                analyzeBtn.disabled = false;
            }
        }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + ' ';
            }
            return fullText;
        }

        async function parseDocx(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            return result.value;
        }

        function processText(text) {
            const removeStop = document.getElementById('removeStopWords').checked;
            const removeSym = document.getElementById('removeSymbols').checked;
            
            // Get Filters
            const minLen = parseInt(minWordLengthInput.value) || 1;
            const maxLen = parseInt(maxWordLengthInput.value) || 999;

            let processed = text.toLowerCase();

            if (removeSym) {
                // ‡∏•‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                processed = processed.replace(/[^a-z\u0E00-\u0E7F\s]/g, ' '); 
            } else {
                // ‡∏•‡∏ö‡πÅ‡∏Ñ‡πà‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                processed = processed.replace(/[.,/#!$%^&*;:{}=\-_`~()]/g, ' ');
            }

            let words = processed.split(/\s+/);

            words = words.filter(word => {
                // 1. Check Empty
                if (!word) return false;
                
                // 2. Check Stopwords
                if (removeStop && defaultStopWords.has(word)) return false;
                
                // 3. Check Symbols (Digits Only)
                if (removeSym && /^\d+$/.test(word)) return false;

                // 4. Check Length (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà 2-10 ‡∏Ñ‡∏≥ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠)
                if (word.length < minLen) return false;
                if (maxLen > 0 && word.length > maxLen) return false;

                return true;
            });

            const frequencyMap = {};
            words.forEach(word => {
                frequencyMap[word] = (frequencyMap[word] || 0) + 1;
            });

            return Object.entries(frequencyMap).sort((a, b) => b[1] - a[1]);
        }

        function displayResults(wordList) {
            resultsSection.classList.remove('hidden');
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Canvas
            const containerWidth = canvas.parentElement.offsetWidth;
            canvas.width = containerWidth;
            canvas.height = 500;
            const ctx = canvas.getContext('2d');
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Canvas ‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const shape = shapeSelect.value;
            const limit = parseInt(maxWordsRange.value); // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î (Slider)

            // ‡∏ï‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const cloudList = wordList.slice(0, limit);

            if (cloudList.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á)");
                return;
            }

            wordCountBadge.textContent = `‡πÅ‡∏™‡∏î‡∏á ${cloudList.length} ‡∏Ñ‡∏≥`;

            const maxFreq = cloudList[0][1];
            // Scaling logic
            const factor = (containerWidth > 600 ? 120 : 60) / maxFreq; 

            // ‡∏ß‡∏≤‡∏î Word Cloud
            WordCloud(canvas, {
                list: cloudList,
                gridSize: 8,
                weightFactor: function (size) {
                    return Math.max(size * factor, 12); 
                },
                fontFamily: 'Sarabun, sans-serif',
                color: 'random-dark',
                rotateRatio: 0.5,
                rotationSteps: 2,
                backgroundColor: '#ffffff', // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ Library
                shape: shape,
                drawOutOfBound: false,
                shrinkToFit: true,
                clearCanvas: true // ‡∏ö‡∏≠‡∏Å Library ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠ Top 100)
            const tableLimit = 100;
            const topN = wordList.slice(0, tableLimit);
            freqTableBody.innerHTML = '';
            
            topN.forEach((item, index) => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item[0]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600 font-bold">${item[1]}</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${item[0].length}</td>
                    </tr>
                `;
                freqTableBody.innerHTML += row;
            });
            
            // Scroll to results
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

    </script>
</body>
</html>
